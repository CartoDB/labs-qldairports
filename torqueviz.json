{"id":"f9a2db86-4ceb-11e5-a5b4-0e4fddd5de28","version":"0.1.0","title":"qld_torque_table","likes":0,"description":null,"scrollwheel":false,"legends":true,"url":null,"map_provider":"leaflet","bounds":[[-65.6582745198266,-316.7578125],[69.41124235697256,138.515625]],"center":"[4.915832801313178, -89.12109375]","zoom":2,"updated_at":null,"layers":[{"options":{"default":"true","url":"http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png","subdomains":"abcd","minZoom":"0","maxZoom":"18","name":"Positron","className":"positron_rainbow_labels","attribution":"&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors &copy; <a href= \"http://cartodb.com/attributions\">CartoDB</a>","labels":{"url":"http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png"},"urlTemplate":"http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png"},"infowindow":null,"tooltip":null,"id":"8f8c48bb-6ec1-4e13-a22f-73bcfee3f371","order":0,"parent_id":null,"children":[],"type":"tiled"},{"id":"4c43c31f-0a9a-40d1-9901-167095ce24ba","parent_id":null,"children":[],"type":"torque","order":1,"legend":{"type":"category","show_title":false,"title":"","template":"","visible":true,"items":[{"name":"Domestic","visible":true,"value":"#F11810"},{"name":"International","visible":true,"value":"#1F78B4"}]},"options":{"stat_tag":"f9a2db86-4ceb-11e5-a5b4-0e4fddd5de28","maps_api_template":"https://{user}.cartodb.com:443","sql_api_template":"https://{user}.cartodb.com:443","tiler_protocol":"http","tiler_domain":"cartodb.com","tiler_port":"80","sql_api_protocol":"http","sql_api_domain":"cartodb.com","sql_api_endpoint":"/api/v2/sql","sql_api_port":80,"layer_name":"qld_torque_table","query":"select *, (CASE WHEN \"flight_type\" = 'Domestic' THEN 1 WHEN \"flight_type\" = 'International' THEN 2 ELSE 3 END) as torque_category FROM (with -- first data, main cities of the world\ndata as (\n  select * from athompson.flight_cube_query_09_06_15_dests_corrected\n  where\n    calendaryear = 2010  AND -- change the year\n    calendarmonth IN ('April') -- change the month\n), -- from OOL and others\norigin as (\n  select * from athompson.flight_cube_query_09_06_15_origins where cartodb_id = 1753 -- change the id based on airport\n), -- get cities closer to 14000 Km\ndests as (\n  select d.*,\n  (ST_Distance(\n    o.the_geom::geography, \n    d.the_geom::geography \n  ))/1000::int distance\n  from data d, origin o\n), -- generate lines using the geographic maxmimum circle\nlines as(\n  select\n  dests.cartodb_id, dests.calendarmonth, dests.calendaryear, dests.city_pair, dests.flight_type, dests.load, dests.distance,\n  ST_Transform(\n     ST_Segmentize(\n       ST_MakeLine(\n         ST_Transform(origin.the_geom, 953027),\n         ST_Transform(dests.the_geom, 953027)\n       ), \n       100000\n     ), \n    3857 \n   ) the_geom_webmercator\n  from origin,dests\n), -- steps to interpolate, 300 per route, from 0 to 1\nsteps as (\n  select lines.cartodb_id,\n    generate_series(0, 300, 1 )/300.0 step\n  from lines\n) -- finally the points over lines\nselect\n  -- fake autonum\n  row_number() over (partition by 1) cartodb_id,\n  -- fake category (needed by torque)\n  lines.city_pair, lines.flight_type, 1 as fakecat,\n  -- calculate the timing of each point starting with this date\n  timestamp '2015-08-23 10:00'\n    -- they will all arrive _almost_ at the same time\n    -- to the destiny (1 hour would be same time)\n    - interval '45 minutes' * (lines.distance/1000.0)\n    -- some random exit distribution using modulus\n    + interval '1 hour' * (lines.cartodb_id % 15)\n    -- actual distribution across the line at 1000km/h speed\n    + interval '1 hour' * (steps.step*lines.distance/(1000.0)) faketime ,\n  -- get a point on the line using the step\n  ST_LineInterpolatePoint(\n    lines.the_geom_webmercator,\n    steps.step\n  ) the_geom_webmercator\nfrom lines\njoin steps on lines.cartodb_id = steps.cartodb_id\norder by steps.step) _cdb_wrap","visible":true,"table_name":"qld_torque_table","user_name":"athompson","tile_style":"/** torque_cat visualization */\n\nMap {\n-torque-frame-count:256;\n-torque-animation-duration:30;\n-torque-time-attribute:\"faketime\";\n-torque-aggregation-function:\"CDB_Math_Mode(torque_category)\";\n-torque-resolution:2;\n-torque-data-aggregation:linear;\n}\n\n#qld_torque_table{\n  comp-op: source-over;\n  marker-fill-opacity: 0.9;\n  marker-line-color: #FFF;\n  marker-line-width: 0;\n  marker-line-opacity: 1;\n  marker-type: ellipse;\n  marker-width: 6;\n  marker-fill: #0F3B82;\n}\n#qld_torque_table[frame-offset=1] {\n marker-width:8;\n marker-fill-opacity:0.45; \n}\n#qld_torque_table[frame-offset=2] {\n marker-width:10;\n marker-fill-opacity:0.225; \n}\n#qld_torque_table[value=1] {\n   marker-fill: #F11810;\n}\n#qld_torque_table[value=2] {\n   marker-fill: #1F78B4;\n}"}},{"options":{"default":"true","url":"http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png","subdomains":"abcd","minZoom":"0","maxZoom":"18","attribution":"&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors &copy; <a href= \"http://cartodb.com/attributions\">CartoDB</a>","urlTemplate":"http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png","type":"Tiled","name":"Positron Labels"},"infowindow":null,"tooltip":null,"id":"c0525816-da40-4505-a467-79df382f0706","order":2,"parent_id":null,"children":[],"type":"tiled"}],"overlays":[{"type":"share","order":2,"options":{"display":true,"x":20,"y":20},"template":""},{"type":"search","order":3,"options":{"display":true,"x":60,"y":20},"template":""},{"type":"zoom","order":6,"options":{"display":true,"x":20,"y":20},"template":"<a href=\"#zoom_in\" class=\"zoom_in\">+</a> <a href=\"#zoom_out\" class=\"zoom_out\">-</a>"},{"type":"loader","order":8,"options":{"display":true,"x":20,"y":150},"template":"<div class=\"loader\" original-title=\"\"></div>"},{"type":"logo","order":9,"options":{"display":true,"x":10,"y":40},"template":""}],"prev":null,"next":null,"transition_options":{"time":0}}